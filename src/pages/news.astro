---
import BaseLayout from '../layouts/BaseLayout.astro';
import NoteFeed from '../components/NoteFeed.astro';
import { breadcrumbSchema } from '../lib/schema';
import { fetchNoteFeed } from '../lib/noteFeed';

const NOTE_FEED_URL = 'https://note.com/chanto_holdings/rss/';
const NOTE_FEED_LIMIT = 10;

let noteItems = [];
try {
  noteItems = await fetchNoteFeed(NOTE_FEED_URL, NOTE_FEED_LIMIT);
} catch (error) {
  console.error('noteフィードの取得に失敗しました', error);
}

const newsItems = [
  { date: '2024-02-10', title: '春の体験ウィーク受付開始', detail: '3/1〜3/10は毎日体験授業を実施します。予約フォームからご希望日時を選択ください。' },
  { date: '2024-01-20', title: 'Cosmos Party参加者募集', detail: '3/20開催のCosmos Partyでは地域の大人との交流タイムを拡充します。' },
];

const sortedNews = [...newsItems].sort((a, b) => {
  const aDate = new Date(a.date).getTime();
  const bDate = new Date(b.date).getTime();
  return bDate - aDate;
});

const structuredData = [
  breadcrumbSchema([
    { name: 'ホーム', item: 'https://mittyan-star.github.io/kyoshitsu/' },
    { name: 'お知らせ', item: 'https://mittyan-star.github.io/kyoshitsu/news' },
  ]),
  {
    '@context': 'https://schema.org',
    '@type': 'ItemList',
    name: '最新のお知らせ',
    itemListElement: sortedNews.map((item, index) => ({
      '@type': 'ListItem',
      position: index + 1,
      name: item.title,
      url: 'https://mittyan-star.github.io/kyoshitsu/news',
      item: {
        '@type': 'NewsArticle',
        headline: item.title,
        datePublished: item.date,
        description: item.detail,
      },
    })),
  },
  {
    '@context': 'https://schema.org',
    '@type': 'ItemList',
    name: 'note更新情報',
    itemListElement: noteItems.map((item, index) => ({
      '@type': 'ListItem',
      position: index + 1,
      name: item.title,
      url: item.link ?? NOTE_FEED_URL,
      item: {
        '@type': 'NewsArticle',
        headline: item.title,
        datePublished: item.isoDate,
        description: item.contentSnippet,
      },
    })),
  },
];
---
<BaseLayout
  title="お知らせ｜最新情報とリリース"
  description="みっちゃん塾のお知らせ一覧。体験ウィーク、Cosmos Partyなどの最新情報を掲載します。"
  path="/news"
  summary="イベント募集や休講情報など最新のお知らせを随時更新しています。"
  breadcrumbs={[{ href: '/news', label: 'お知らせ' }]}
  structuredData={structuredData}
>
  <section class="section">
    <h1 class="text-3xl font-bold text-slate-900">最新のお知らせ</h1>
    <div class="mt-8 space-y-8">
      <section>
        <h2 class="text-xl font-semibold text-slate-900">note更新情報</h2>
        <NoteFeed
          items={noteItems}
          feedUrl={NOTE_FEED_URL}
          limit={NOTE_FEED_LIMIT}
          emptyMessage="現在、noteでのお知らせはありません。"
        />
      </section>
      <section>
        <h2 class="text-xl font-semibold text-slate-900">教室からのお知らせ</h2>
        <ul class="space-y-4">
          {sortedNews.map((item) => (
            <li class="rounded-lg border border-slate-200 bg-white p-4 shadow-sm">
              <p class="text-xs text-slate-500">{item.date}</p>
              <h2 class="text-lg font-semibold text-blue-700">{item.title}</h2>
              <p class="mt-2 text-sm text-slate-600">{item.detail}</p>
            </li>
          ))}
          {sortedNews.length === 0 && (
            <li class="rounded-lg border border-dashed border-slate-200 bg-white p-4 text-sm text-slate-500">
              現在お知らせはありません。LINEに登録いただくと最新情報をいち早くお届けします。
            </li>
          )}
        </ul>
      </section>
    </div>
  </section>
</BaseLayout>
