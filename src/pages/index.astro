---
import BaseLayout from '../layouts/BaseLayout.astro';
import CTAButton from '../components/CTAButton.astro';
import FAQAccordion from '../components/FAQAccordion.astro';
import NoteFeed from '../components/NoteFeed.astro';
import { organizationSchema, breadcrumbSchema } from '../lib/schema';
import { withBase } from '../lib/url';
import { getCollection } from 'astro:content';
import { fetchNoteFeed } from '../lib/noteFeed';

const NOTE_FEED_URL = 'https://note.com/chanto_holdings/rss/';
const NOTE_FEED_LIMIT = 1;

let noteItems = [];
try {
  noteItems = await fetchNoteFeed(NOTE_FEED_URL, NOTE_FEED_LIMIT);
} catch (error) {
  console.error('noteフィードの取得に失敗しました', error);
}

const events = await getCollection('events', ({ data }) => !!data);

const toDate = (value?: string) => (value ? new Date(value) : undefined);
const today = new Date();
today.setHours(0, 0, 0, 0);

const sortedEvents = [...events].sort((a, b) => {
  const aDate = toDate(a.data.startDate)?.getTime() ?? Number.MAX_SAFE_INTEGER;
  const bDate = toDate(b.data.startDate)?.getTime() ?? Number.MAX_SAFE_INTEGER;
  return aDate - bDate;
});

const upcomingEvents = sortedEvents.filter(({ data }) => {
  const start = toDate(data.startDate);
  if (!start) return true;
  return start.getTime() >= today.getTime();
});

const highlightedEvents = (upcomingEvents.length > 0 ? upcomingEvents : sortedEvents).slice(0, 2);
const structuredData = [
  organizationSchema({
    name: 'みっちゃん塾',
    url: 'https://mittyan-star.github.io/kyoshitsu',
    logo: 'https://mittyan-star.github.io/kyoshitsu/favicon.svg',
    sameAs: ['https://www.instagram.com/', 'https://line.me/'],
  }),
  breadcrumbSchema([
    { name: 'ホーム', item: 'https://mittyan-star.github.io/kyoshitsu/' },
  ]),
  {
    '@context': 'https://schema.org',
    '@type': 'ItemList',
    name: '最新のnote記事',
    itemListElement: noteItems.map((item, index) => ({
      '@type': 'ListItem',
      position: index + 1,
      url: item.link ?? NOTE_FEED_URL,
      name: item.title,
    })),
  },
  {
    '@context': 'https://schema.org',
    '@type': 'ItemList',
    name: '開催予定のイベント',
    itemListElement: highlightedEvents.map((entry, index) => ({
      '@type': 'ListItem',
      position: index + 1,
      url: `https://mittyan-star.github.io/kyoshitsu/events/${entry.slug}`,
      name: entry.data.title,
    })),
  },
];
---
<BaseLayout
  title="みっちゃん塾｜生徒が説明する学びで思考力を伸ばす"
  description="兵庫・六甲道の個別指導×探究塾。生徒が説明する学びで説明力と思考力を育て、京大数学レベルまで届くプロセスを身につけます。"
  path="/"
  summary="生徒が説明する学び×ワンフレーズ報告×プレゼン教育で、思考力と発信力を一度に鍛える地域密着の学習コミュニティ。"
  structuredData={structuredData}
>
  <section class="section">
    <h1 class="text-3xl font-bold text-slate-900">学びを社会につなぐ、神戸の学習コミュニティ</h1>
    <p>
      みっちゃん塾は、生徒が授業内容を先生や仲間に説明するスタイルで学びを深めます。ワンフレーズ報告や地域連携プロジェクトを通して、学力だけでなく伝える力・実行力を育てます。
    </p>
    <div class="cta-grid">
      <CTAButton href="/reserve" label="体験予約（3クリックで完了）" />
      <CTAButton href="https://lin.ee/IfZbpy5" label="LINEで相談" variant="secondary" />
    </div>
  </section>

  <section class="section">
    <h2>みっちゃん塾の特徴</h2>
    <div class="cards">
      <article class="rounded-xl bg-white p-6 shadow-sm">
        <h3 class="text-xl font-semibold text-blue-700">生徒が説明する授業</h3>
        <p class="mt-2 text-sm leading-relaxed text-slate-600">
          解法を先生に説明することで、思考の筋道とアウトプット力を磨きます。先生は聞き役に徹し、問い返しで理解を深めます。
        </p>
      </article>
      <article class="rounded-xl bg-white p-6 shadow-sm">
        <h3 class="text-xl font-semibold text-blue-700">ワンフレーズ報告</h3>
        <p class="mt-2 text-sm leading-relaxed text-slate-600">
          授業後30秒の音声報告で「できたこと」「次にやること」を整理し、保護者へ即時共有します。家庭と塾の連携が密になります。
        </p>
      </article>
      <article class="rounded-xl bg-white p-6 shadow-sm">
        <h3 class="text-xl font-semibold text-blue-700">プレゼン×実社会課題</h3>
        <p class="mt-2 text-sm leading-relaxed text-slate-600">
          Cosmos Party や地域イベントで探究成果を発表。社会との接点を持ちながら、学びをアウトカムにつなげます。
        </p>
      </article>
    </div>
  </section>

  <section class="section">
    <h2>最新のnote記事</h2>
    <NoteFeed
      items={noteItems}
      feedUrl={NOTE_FEED_URL}
      limit={NOTE_FEED_LIMIT}
      snippetLength={50}
      emptyMessage="noteの記事を準備中です。"
    />
  </section>

  <section class="section">
    <h2>開催予定のイベント</h2>
    <ul class="space-y-4">
      {highlightedEvents.map(({ slug, data }) => (
        <li class="rounded-lg border border-slate-200 bg-white p-4 shadow-sm">
          <a href={withBase(`/events/${slug}`)} class="text-lg font-semibold text-blue-700">{data.title}</a>
          <p class="mt-1 text-sm text-slate-600">{data.description}</p>
          <p class="mt-2 text-xs text-slate-500">{data.startDate} @ {data.location}</p>
        </li>
      ))}
      {highlightedEvents.length === 0 && (
        <li class="rounded-lg border border-dashed border-slate-200 bg-white p-4 text-sm text-slate-500">
          現在予定されているイベントはありません。近日中に更新します。
        </li>
      )}
    </ul>
  </section>

  <FAQAccordion
    items={[
      {
        question: '体験授業は何を行いますか？',
        answer: '通常授業と同じく、生徒が問題を解き方まで説明するプロセスを体験し、ワンフレーズ報告まで実践します。',
      },
      {
        question: '入会までの流れを教えてください。',
        answer: '体験予約→面談→初回オリエンテーション→学習計画確定の4ステップです。決済は入会後にご案内します。',
      },
      {
        question: '振替や欠席対応は可能ですか？',
        answer: '前日までのご連絡で振替対応いたします。オンライン接続の振替も柔軟に行っています。',
      },
    ]}
  />
</BaseLayout>
